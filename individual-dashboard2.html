<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Individual Dashboard - SafeTour Connect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- LIGHT/TRUSTWORTHY GROUP ADMIN PALETTE --- */
        :root {
            --color-primary: #0072E1; 
            --color-secondary: #00BCD4; 
            --color-accent-happy: #FFC300; 
            
            --primary-bg: #F7F9FF; 
            --secondary-bg: #FFFFFF; 
            
            --text-color-dark: #333333;
            --text-color-soft: #555555;
            --danger-color: #FF6347;
            --success-color: #28A745; 
            --info-color: #4A69BB; 
            --container-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Poppins', sans-serif;
            background: var(--primary-bg);
            color: var(--text-color-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--secondary-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin: 0;
            padding: 1.5rem 2.5rem;
            border-bottom: 3px solid var(--color-primary);
        }
        .navbar h1 {
            color: var(--color-primary);
            font-weight: 700;
            font-size: 1.6rem;
        }
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .logout-btn:hover {
            background-color: #d14931;
            transform: translateY(-2px);
        }
        .dashboard-container {
            flex-grow: 1;
            max-width: 1200px;
            width: 100%;
            margin: 2rem auto;
            padding: 0 1rem;
        }
        .dashboard-container h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--text-color-dark);
            font-weight: 700;
            font-size: 2rem;
        }
        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            padding-bottom: 40px;
        }
        .member-card {
            background: var(--secondary-bg);
            padding: 2rem;
            border-radius: 18px;
            box-shadow: var(--container-shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.3s ease;
            border: 1px solid #E0E0E0;
            position: relative;
        }
        .member-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        .member-card h3 {
            color: var(--color-primary);
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            font-weight: 700;
        }
        .member-card p {
            margin: 0.3rem 0;
            opacity: 0.8;
            color: var(--text-color-soft);
            font-size: 0.9rem;
        }
        .member-card strong {
            color: var(--text-color-dark);
        }
        .id-details {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #E0E0E0;
            width: 100%;
            font-size: 0.95rem;
        }
        .qr-code-container {
            margin: 1rem auto;
            padding: 0.5rem;
            background: #F8F8F8;
            border-radius: 8px;
            display: inline-block;
        }
        .id-card-actions {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }
        .action-btn {
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        .action-btn.generate-btn {
            background-color: var(--success-color);
        }
        .action-btn.generate-btn:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        .action-btn.share, .action-btn.download {
            background-color: var(--color-primary);
        }
        .action-btn.share:hover, .action-btn.download:hover {
            background-color: #0056e6;
            transform: translateY(-2px);
        }

        /* --- Download Card Styling (for html2canvas) --- */
        .download-card-wrapper {
            /* Styles necessary for the export function */
            box-sizing: content-box;
            width: 336px;
            height: 192px;
        }

        /* Footer */
        footer {
            width: 100%;
            padding: 1rem;
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            background-color: var(--secondary-bg);
            flex-shrink: 0;
            margin-top: auto;
            color: var(--text-color-soft);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                align-items: center;
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <h1><i class="fas fa-users-cog mr-2" style="color: var(--color-primary);"></i> Individual Group Dashboard</h1>
        <div class="navbar-links">
            <button class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </header>
    <div class="dashboard-container">
        <h2 id="group-name-heading">My Group</h2>
        <div class="card-grid" id="member-cards-container">
            </div>
    </div>
    <footer>
        &copy; 2025 SafeTour Connect
    </footer>
    <div id="temp-card-for-download" style="display:none;"></div>
    
    <script>
        const API_BASE_URL = 'http://localhost:3000'; // Server URL

        const groupAdmin = JSON.parse(localStorage.getItem('loggedInUser'));
        const memberCardsContainer = document.getElementById('member-cards-container');
        
        // --- Security Check ---
        if (!groupAdmin || groupAdmin.role !== 'individual-group') {
            window.location.href = 'individual-login.html';
            return;
        }

        document.getElementById('group-name-heading').innerText = `${groupAdmin.groupName || 'My Group'} - Group Admin`;

        let groupMembers = []; // Array to hold live member data

        // --- CORE DATA FETCH FUNCTION ---
        async function fetchGroupMembers() {
            try {
                // Fetch all tourists assigned to this specific groupAdmin ID
                const response = await fetch(`${API_BASE_URL}/api/tourists/by-guide/${groupAdmin.id}`); // NOTE: Assuming we create a custom API route for this

                if (response.status === 404) {
                    groupMembers = [];
                    return; // No members found
                }
                if (!response.ok) {
                    throw new Error('Failed to fetch group members data.');
                }
                
                groupMembers = await response.json(); // Store live data
                renderMemberCards();

            } catch (error) {
                console.error('Error fetching group members:', error);
                memberCardsContainer.innerHTML = '<p style="margin-top:2rem; color: var(--danger-color);">Error loading members. Please check the server connection.</p>';
            }
        }

        // --- QR CODE GENERATION & RENDERING LOGIC ---
        function generateQrCode(virtualID, memberId) {
            const qrCodeData = JSON.stringify(virtualID);
            const qrCodeContainer = document.getElementById(`qr-code-container-${memberId}`);
            
            if (qrCodeContainer) {
                qrCodeContainer.innerHTML = ''; 
                // Using a smaller size for display on the dashboard
                new QRCode(qrCodeContainer, {
                    text: qrCodeData,
                    width: 80,
                    height: 80,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
            }
        }

        function renderMemberCards() {
            memberCardsContainer.innerHTML = '';

            if (groupMembers.length === 0) {
                memberCardsContainer.innerHTML = '<p style="margin-top:2rem; color: var(--text-color-soft);">No members found in your group. Assign members via the main Guide Dashboard.</p>';
                return;
            }

            groupMembers.forEach((member) => {
                const memberCard = document.createElement('div');
                memberCard.classList.add('member-card');
                
                memberCard.innerHTML = `
                    <h3>${member.name}</h3>
                    <p><strong>Age:</strong> ${member.age || 'N/A'}</p>
                    <p><strong>Card Type:</strong> ${member.cardType || 'Standard'}</p>
                    <p><strong>Destination:</strong> ${member.destination || 'N/A'}</p>
                    <div class="id-details" id="id-details-${member._id}">
                        ${member.virtualID ? 
                            `<h4 style="margin-bottom: 1rem;"><i class="fas fa-check-circle" style="color:var(--success-color);"></i> Virtual ID Generated</h4>
                            <div class="qr-code-container" id="qr-code-container-${member._id}"></div>
                            <div class="id-card-actions">
                                <button class="action-btn download download-btn" data-id="${member._id}"><i class="fas fa-download"></i> Download Image</button>
                                <button class="action-btn share share-btn" data-id="${member._id}"><i class="fas fa-envelope"></i> Share Details</button>
                            </div>` 
                            : `<button class="action-btn generate-btn" data-id="${member._id}"><i class="fas fa-id-card"></i> Generate Virtual ID</button>`
                        }
                    </div>
                `;
                memberCardsContainer.appendChild(memberCard);

                if (member.virtualID) {
                    generateQrCode(member.virtualID, member._id);
                }
            });
        }
        
        // --- Event Listeners ---

        document.addEventListener('click', (event) => {
            const target = event.target.closest('button, .download-btn, .share-btn, .generate-btn');
            if (!target) return;

            const memberId = target.dataset.id;
            const member = groupMembers.find(m => m._id === memberId);
            if (!member) return;

            // Handle ID Generation (This would trigger a PUT request to the server)
            if (target.classList.contains('generate-btn')) {
                alert('ID Generation must be performed on the Guide Dashboard for consistency.');
                window.location.href = 'tourist-id-generation.html';
            } 
            
            // Handle Download (Requires html2canvas)
            else if (target.classList.contains('download-btn')) {
                alert('Download logic triggered for ' + member.name);
                // The html2canvas logic for download would go here.
            } 
            
            // Handle Share via Email
            else if (target.classList.contains('share-btn')) {
                const subject = encodeURIComponent(`Your Smart Tourist Virtual ID - ${member.name}`);
                const body = encodeURIComponent(`Hello ${member.name},\n\nYour ID is: ${member.virtualID.id}.`);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            }
        });

        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            window.location.href = 'individual-login.html';
        });
        
        // Initial Data Load
        document.addEventListener('DOMContentLoaded', fetchGroupMembers);
    </script>
</body>
</html>