<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location & SOS System - Tourist View</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Nunito:wght@700&display=swap" rel="stylesheet">

    <style>
        /* --- UI/UX VARS (LIGHT/FRIENDLY THEME) --- */
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes sos-glow {
            0% { box-shadow: 0 0 10px #FF6347; }
            50% { box-shadow: 0 0 30px #FF6347; }
            100% { box-shadow: 0 0 10px #FF6347; }
        }
        
        :root {
            --color-primary: #0072E1; 
            --color-accent-happy: #FFC300; 
            --primary-bg: #F7F9FF; 
            --secondary-bg: #FFFFFF; 
            --text-color: #333333;
            --info-button-bg: #E0E0E0; 
            --danger-color: #FF6347; 
            --container-shadow: 0 4px 20px rgba(0, 0, 0, 0.1); 
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--primary-bg); 
            color: var(--text-color); 
            height: 100vh;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        /* --- CORE LAYOUT FIX: FULL SCREEN FLEX --- */
        #active-trip-view { 
            width: 100%; 
            height: 100%;
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            padding: 1rem;
        }
        @media (min-width: 1024px) {
            #active-trip-view {
                flex-direction: row;
            }
        }
        
        /* Map container */
        #map-container {
            flex-grow: 1; 
            height: 55%; 
            position: relative;
        }
        @media (min-width: 1024px) {
            #map-container {
                height: 100%;
            }
        }
        #tourist-map { 
            border-radius: 12px; 
            height: 100%; 
            width: 100%; 
            box-shadow: var(--container-shadow);
        }
        
        /* Control panel styling */
        #control-panel {
            width: 100%;
            height: 45%; 
            flex-shrink: 0; 
            background: var(--secondary-bg); 
            border-radius: 12px; 
            box-shadow: var(--container-shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            border: 1px solid #EAEAEA;
        }
        @media (min-width: 1024px) {
            #control-panel {
                width: 384px; 
                height: 100%;
            }
        }
        
        /* --- CONTROL PANEL ELEMENTS --- */
        #control-panel h2 { 
            font-family: 'Nunito', sans-serif; 
            font-size: 1.6rem; 
            font-weight: 800; 
            margin-bottom: 1.5rem; 
            color: var(--color-primary);
            border-bottom: 3px solid var(--color-accent-happy); 
            padding-bottom: 0.75rem;
        }

        /* ID Card Styling (Blue gradient for brand trust) */
        .id-card-horizontal {
            background: linear-gradient(135deg, #0072E1, #00BCD4);
            color: white;
            border-radius: 10px; 
            padding: 1rem; 
            box-shadow: 0 4px 15px rgba(0, 114, 225, 0.3);
            align-items: center;
        }
        .id-card-horizontal .name { 
            font-size: 1.15rem;
            font-weight: 700;
            color: white;
        }
        .id-card-horizontal .text-yellow-300 {
            color: var(--color-accent-happy);
        }
        .id-card-horizontal .qr-code { 
            background: white; 
            border-radius: 4px; 
            padding: 4px; 
            flex-shrink: 0;
        }

        /* Location Info Box */
        #location-info {
            background: #F0F4FF; 
            border: 1px solid var(--color-primary); 
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        #location-info h3 {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--color-primary);
        }
        #coordinates-display {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-color);
        }
        
        /* Location Status Display (Map Overlay) */
        .location-status { 
            position: absolute; top: 1rem; right: 1rem; z-index: 1000; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 0.75rem 1.25rem;
            border-radius: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-weight: 600;
            color: #444; 
        }
        .status-dot.active { 
            background: #22c55e; 
            animation: pulse 1.5s infinite;
        }
        
        /* --- BUTTON LAYOUT AND STYLING FIXES --- */
        .action-button-group {
            justify-content: space-between;
        }
        .action-button-group a, .action-button-group button {
            flex-grow: 1; 
            width: 48%; 
        }
        .control-btn {
            background-color: var(--info-button-bg);
            color: #333;
            padding: 0.75rem; 
            font-weight: 600;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-decoration: none; 
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .control-btn:hover {
             background-color: #C0C0C0;
             transform: translateY(-2px);
        }

        /* SOS Button Dominance */
        #panic-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 1.8rem;
            font-size: 1.4rem;
            font-weight: 800;
            box-shadow: 0 0 15px var(--danger-color);
            animation: sos-glow 2s infinite; 
            cursor: pointer;
        }
        #panic-btn:hover {
            background-color: #d14931;
        }
        
        /* Logout Link */
        .logout-link {
            text-decoration: none;
            color: #777;
            transition: color 0.2s;
            cursor: pointer;
        }
        .logout-link:hover {
            color: var(--danger-color);
        }

        /* --- SOS MODAL / ALERT SCREEN STYLES (CRITICAL FIX) --- */
        .sos-modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center; 
            z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s; 
            backdrop-filter: blur(5px);
        }
        .sos-modal-overlay.show { 
            opacity: 1; visibility: visible; 
        }
        /* FIX 1: Countdown Modal Visibility */
        .sos-modal { 
            background: white; 
            color: var(--text-color); 
            border: 3px solid var(--danger-color);
            box-shadow: 0 8px 30px rgba(255,99,71,0.5);
            max-width: 90%;
            width: 400px;
        }
        .sos-modal h3 { color: var(--danger-color); }
        .sos-modal #modal-countdown { font-weight: 800; font-size: 3rem; }
        
        /* FIX 2: Final Alert Screen visibility and aesthetics */
        #final-alert-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.98); 
            z-index: 10000; 
            display: none; 
            justify-content: center; align-items: center;
        }
        #final-alert-content {
            background: white;
            color: var(--text-color);
            border: 2px solid var(--danger-color);
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 3rem;
            max-width: 600px;
        }
        #final-alert-content h2 { 
            color: var(--danger-color); 
        }
        
        /* FIX 3: Styling the emergency call and email boxes */
        .emergency-call-box {
            background-color: #FFC0CB; 
            border: 1px solid var(--danger-color);
        }
        .emergency-call-box p {
            color: var(--danger-color);
        }
        .email-content-box {
            background-color: #F0F4FF; 
            border: 1px solid #AAA;
        }
        #email-body-output {
            background: #EAEAEA; 
            color: #333;
            border: 1px solid #AAA;
        }
        
        /* Leaflet popups color */
        .leaflet-popup-content-wrapper { background: white; color: var(--text-color); }
        .leaflet-popup-tip { background: white; }
        .leaflet-popup-content-wrapper a { color: var(--color-primary); }
    </style>
</head>
<body class="w-screen h-screen">

    <div id="sos-modal-overlay" class="sos-modal-overlay">
        <div class="sos-modal p-8 rounded-xl">
            <h3 class="text-2xl font-bold"><i class="fas fa-bell animate-pulse mr-2"></i> EMERGENCY ALERT</h3>
            <p class="mb-6 mt-2 text-lg text-gray-700">A panic alert will be sent in <span id="modal-countdown" class="font-mono text-red-500">10</span> seconds.</p>
            <button id="modal-cancel-btn" class="control-btn px-6 py-3 w-full rounded-full bg-green-500 hover:bg-green-600 text-white">CANCEL ALERT</button>
        </div>
    </div>
    
    <div id="final-alert-screen">
        <div id="final-alert-content" class="rounded-xl">
            <h2 class="text-center text-2xl font-bold mb-6"><i class="fas fa-exclamation-circle mr-2"></i> ALERT CONFIRMED & SENT</h2>
            <p class="text-center mb-6 text-sm text-gray-700 opacity-80">The system has generated the following **Emergency Alert** and attempted to open your mail client.</p>

            <div class="space-y-4">
                <div class="p-4 rounded-lg emergency-call-box">
                    <p class="font-bold mb-2 text-red-700"><i class="fas fa-arrow-right mr-2"></i> 1. **CALL EMERGENCY CONTACT**</p>
                    <a id="call-emergency-btn" href="#" class="control-btn bg-red-600 hover:bg-red-700 text-white w-full">
                        <i class="fas fa-phone-alt mr-2"></i> Call <span id="contact-number-display">--</span> NOW
                    </a>
                </div>

                <div class="p-4 rounded-lg email-content-box">
                    <p class="font-bold mb-2 text-gray-700"><i class="fas fa-envelope mr-2"></i> 2. Email Content (Sent to Admin)</p>
                    <div id="email-body-output" class="text-xs p-2 rounded"></div>
                    <button id="copy-email-btn" class="control-btn mt-3 bg-gray-500 hover:bg-gray-600 text-white w-full"><i class="fas fa-copy mr-1"></i> Copy Email Body</button>
                </div>
            </div>

            <button onclick="document.getElementById('final-alert-screen').style.display='none'; resetSosDashboard();" class="mt-8 w-full control-btn bg-gray-500 hover:bg-gray-600 text-white">
                CLOSE & RETURN TO MAP
            </button>
        </div>
    </div>

    <div id="active-trip-view">
        <div id="map-container">
            <div id="tourist-map"></div>
            <div id="location-status" class="location-status">
                <span id="status-dot" class="status-dot"></span>
                <span id="status-text">Getting location...</span>
            </div>
        </div>

        <div id="control-panel">
            <h2 class="mb-4"><i class="fas fa-user-shield mr-2"></i> Tourist Safety Hub</h2>
            
            <div id="id-card-container" class="mb-6"></div>

            <div id="location-info" class="mb-6 p-4 rounded-lg border" style="background: #F0F4FF; border-color: var(--color-primary);">
                <h3 class="font-semibold mb-2" style="color: var(--color-primary);"><i class="fas fa-location-arrow mr-2 text-red-500"></i> Live Position Data</h3>
                <div id="coordinates-display" class="space-y-1" style="color: var(--text-color);">
                    <div>Latitude: <span id="lat-display">--</span></div>
                    <div>Longitude: <span id="lng-display">--</span></div>
                    <div class="pt-1">
                        <span id="accuracy-display" class="text-xs text-gray-400">Accuracy: --</span>
                    </div>
                </div>
            </div>

            <div class="flex-grow">
            </div>
            
            <div class="text-center mt-auto space-y-4">
                
                <div class="action-button-group flex">
                    <a id="back-btn" href="central-dashboard3.html" class="control-btn">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                    <button id="refresh-location-btn" class="control-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
                
                <button id="center-map-btn" class="control-btn w-full">
                    <i class="fas fa-crosshairs"></i> Center on Me
                </button>
                
                <button id="panic-btn" class="w-full">
                    <i class="fas fa-exclamation-triangle mr-2"></i> PRESS FOR EMERGENCY ALERT
                </button>
                
                <button id="logout-btn" class="w-full mt-4 text-sm logout-link">
                    Logout & End Trip
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000'; // Server URL

        const AppState = {
            map: null,
            marker: null,
            locationWatcherId: null,
            lastKnownLocation: null,
            tourist: null,
            safetyZonesLayer: new L.FeatureGroup()
        };
        let countdownTimer;

        // --- Fetch Safety Zones from Server ---
        async function fetchSafetyZones() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/zones`);
                if (!response.ok) {
                    throw new Error('Failed to fetch zones from server.');
                }
                const data = await response.json();
                
                // Process the fetched data
                AppState.safetyZonesLayer.clearLayers();
                data.forEach(zone => {
                    if (zone.geoJson) {
                        const layer = L.geoJSON(zone.geoJson).getLayers()[0];
                        if (layer) {
                            layer.feature = zone.geoJson; 
                            setLayerStyle(layer, zone.geoJson.properties.type);
                            AppState.safetyZonesLayer.addLayer(layer);
                        }
                    }
                });
            } catch (error) {
                console.error('Error fetching safety zones:', error);
                // Optionally show a map error message
            }
        }
        
        // --- Fetch Logged-in User Data from Server (For fresh emergency contacts) ---
        async function fetchTouristDetails(touristId) {
            try {
                // NOTE: This assumes a new API endpoint exists to fetch a single tourist by ID or name
                // For now, we will use the local storage session data, but the API path should be: 
                // fetch(`${API_BASE_URL}/api/tourist/${touristId}`)
                
                // For server integration, we rely on the data put into localStorage by the login process.
                return JSON.parse(localStorage.getItem('loggedInUser')) || {};

            } catch (error) {
                console.error("Failed to re-fetch user details:", error);
                return {};
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            let loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            
            // SECURITY CHECK: Redirect if not logged in
            if (!loggedInUser || !loggedInUser.username) {
                 window.location.href = 'login.html';
                 return;
            }
            
            // Initial data fetch (use server data for current status)
            AppState.tourist = await fetchTouristDetails(loggedInUser._id); 
            
            // Render ID Card (uses session data for display)
            renderIdCard(AppState.tourist);
            
            // Initialize Map and Geolocation
            initializeTouristMap();
            
            // --- CRITICAL EVENT LISTENERS ---
            document.getElementById('modal-cancel-btn').addEventListener('click', cancelSosAlert);
            document.getElementById('panic-btn').addEventListener('click', startSosCountdown);
            document.getElementById('refresh-location-btn').addEventListener('click', refreshLocation);
            document.getElementById('center-map-btn').addEventListener('click', centerMapOnUser);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            document.getElementById('copy-email-btn').addEventListener('click', () => {
                const emailContent = document.getElementById('email-body-output').textContent;
                const bodyContent = emailContent.split('\n\n').slice(1).join('\n\n').trim();

                navigator.clipboard.writeText(bodyContent).then(() => {
                    alert('Email content copied to clipboard!');
                }).catch(err => {
                    console.error('Could not copy text: ', err);
                });
            });
        });

        function setLayerStyle(layer, type) {
            const isUnsafe = type === 'Unsafe';
            layer.setStyle({
                fillColor: isUnsafe ? '#dc2626' : '#22c55e',
                color: isUnsafe ? '#991b1b' : '#15803d',
                weight: 3,
                fillOpacity: 0.5
            });
            const name = layer.feature && layer.feature.properties ? layer.feature.properties.name : 'Unknown Zone';
            layer.bindPopup(`<b>${type} Area</b><br>${name}`);
        }

        // --- MAP FUNCTIONS (Using Server Fetch) ---
        function loadSafetyZones() {
            // This is now just a wrapper for the server fetch logic
            fetchSafetyZones();
        }

        function updateLocationStatus(status, isActive = false) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            statusText.textContent = status;
            if (isActive) { 
                statusDot.classList.add('active'); 
                document.getElementById('location-status').classList.add('bg-green-500/90', 'text-white');
                document.getElementById('location-status').classList.remove('bg-white/95', 'text-gray-800');
            } else { 
                statusDot.classList.remove('active'); 
                document.getElementById('location-status').classList.add('bg-white/95', 'text-gray-800');
                document.getElementById('location-status').classList.remove('bg-green-500/90', 'text-white');
            }
        }

        function updateLocationDisplay(lat, lng, accuracy = null) {
            document.getElementById('lat-display').textContent = lat.toFixed(6);
            document.getElementById('lng-display').textContent = lng.toFixed(6);
            if (accuracy) { document.getElementById('accuracy-display').textContent = `Accuracy: Â±${Math.round(accuracy)}m`; }
        }

        function renderIdCard(tourist) {
            if (!tourist) return;
            const container = document.getElementById('id-card-container');
            const touristId = tourist.id || tourist.username; 
            const contactNumber = tourist.contact || tourist.emergency; 

            // FIX: Using light theme colors for ID Card in this context
            container.innerHTML = `
                <div class="id-card-horizontal" style="background: linear-gradient(135deg, #0072E1, #00BCD4); color: white; padding: 1rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 114, 225, 0.3); display: flex; align-items: center; gap: 1rem;">
                    <div id="qr-code-placeholder" style="background: white; border-radius: 4px; padding: 4px; flex-shrink: 0;"></div>
                    <div class="details text-left text-white">
                        <div class="name" style="font-weight: 700; font-size: 1.1rem; color: white;">${tourist.name || 'N/A'}</div>
                        <div>ID: <span style="color: #FFC300;">${touristId || 'N/A'}</span></div>
                        <div class="text-xs opacity-70">Contact: ${contactNumber || 'N/A'}</div>
                    </div>
                </div>`;
            
            const qrPlaceholder = document.getElementById("qr-code-placeholder");
            if (qrPlaceholder) {
                qrPlaceholder.innerHTML = ''; 
                new QRCode(qrPlaceholder, {
                    text: JSON.stringify({ id: touristId, name: tourist.name, contact: contactNumber, timestamp: Date.now() }),
                    width: 60, height: 60, correctLevel: QRCode.CorrectLevel.M
                });
            }
        }

        function initializeTouristMap() {
            if (AppState.map) AppState.map.remove();
            
            AppState.map = L.map('tourist-map').setView([28.6139, 77.2090], 13);
            
            // FIX: Using Light-mode map tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(AppState.map);

            AppState.map.addLayer(AppState.safetyZonesLayer);
            
            loadSafetyZones(); // Calls fetchSafetyZones
            
            AppState.map.invalidateSize(); 

            if (!('geolocation' in navigator)) { updateLocationStatus('Geolocation not supported'); return; }

            updateLocationStatus('Requesting location...', false);

            navigator.geolocation.getCurrentPosition(handleLocationSuccess, handleLocationError, { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 });
            startLocationWatching();
        }

        function startLocationWatching() { AppState.locationWatcherId = navigator.geolocation.watchPosition(handleLocationSuccess, handleLocationError, { enableHighAccuracy: true, timeout: 15000, maximumAge: 5000 }); }
        
        function handleLocationSuccess(position) {
            const { latitude, longitude, accuracy } = position.coords;
            AppState.lastKnownLocation = { lat: latitude, lng: longitude, accuracy };
            updateLocationStatus('Location active', true);
            updateLocationDisplay(latitude, longitude, accuracy);
            
            if (!AppState.marker) {
                const userIcon = L.divIcon({ html: `<i class="fas fa-map-marker-alt text-blue-500 text-3xl"></i>`, className: 'leaflet-div-icon', iconSize: [30, 40], iconAnchor: [15, 40] });
                AppState.marker = L.marker([latitude, longitude], { icon: userIcon }).addTo(AppState.map).bindPopup('<b>You are here!</b>').openPopup();
                AppState.map.setView([latitude, longitude], 16);
            } else { AppState.marker.setLatLng([latitude, longitude]); }
            AppState.map.invalidateSize(); 
        }

        function handleLocationError(error) { 
            updateLocationStatus('Location failed', false); 
            console.error("Geolocation error:", error); 
        }

        function centerMapOnUser() { 
            if (AppState.lastKnownLocation) { 
                AppState.map.setView([AppState.lastKnownLocation.lat, AppState.lastKnownLocation.lng], 17, {animate: true}); 
            } else {
                alert("Your location is not yet available.");
            }
        }
        function refreshLocation() { 
            updateLocationStatus('Requesting location...', false);
            navigator.geolocation.getCurrentPosition(handleLocationSuccess, handleLocationError, { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }); 
        }
        
        function startSosCountdown() {
            if (!AppState.tourist) {
                console.error("Tourist data missing. Cannot start SOS.");
                return;
            }
            const modalOverlay = document.getElementById('sos-modal-overlay');
            const countdownSpan = document.getElementById('modal-countdown');
            const panicBtn = document.getElementById('panic-btn');

            modalOverlay.classList.add('show');
            panicBtn.disabled = true;

            let timeLeft = 10; 
            countdownSpan.textContent = timeLeft;

            countdownTimer = setInterval(() => {
                timeLeft--;
                countdownSpan.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    sendSosAlert();
                }
            }, 1000);
        }

        function cancelSosAlert() {
            clearInterval(countdownTimer);
            resetSosDashboard();
        }

        function sendSosAlert() {
            if (!AppState.tourist || !AppState.lastKnownLocation) { 
                console.error("SOS failed due to missing data.");
                resetSosDashboard(); 
                return; 
            }

            const { lat, lng } = AppState.lastKnownLocation;
            const mapsLink = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
            
            const timestamp = new Date().toLocaleString();
            
            const touristName = AppState.tourist.name;
            const touristId = AppState.tourist.id;
            const emergencyContact = AppState.tourist.contact || AppState.tourist.emergency; 
            const targetEmail = 'shivanshti10@gmail.com'; 

            const subject = `ðŸš¨ URGENT: PANIC ALERT from Tourist ${touristName} (ID: ${touristId})`;
            const body = `EMERGENCY PANIC ALERT\n\n` +
                         `Tourist Details:\n` +
                         `Name: ${touristName}\n` +
                         `ID: ${touristId}\n` +
                         `Emergency Contact: ${emergencyContact || 'Not Available'}\n\n` +
                         `Location Information:\n` +
                         `Latitude: ${lat}\n` +
                         `Longitude: ${lng}\n` +
                         `Timestamp: ${timestamp}\n\n` +
                         `Google Maps Link:\n${mapsLink}\n\n` +
                         `This is an automated emergency alert. Please respond immediately.`;
            
            document.getElementById('email-body-output').textContent = `To: ${targetEmail}\nSubject: ${subject}\n\n${body}`;

            document.getElementById('call-emergency-btn').href = `tel:${emergencyContact}`;
            document.getElementById('contact-number-display').textContent = emergencyContact || 'N/A';

            document.getElementById('sos-modal-overlay').classList.remove('show');
            document.getElementById('final-alert-screen').style.display = 'flex';
            
            window.open(`mailto:${targetEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }
        
        function resetSosDashboard() {
            document.getElementById('sos-modal-overlay').classList.remove('show');
            document.getElementById('panic-btn').disabled = false;
        }

        function handleLogout() {
            localStorage.removeItem('loggedInUser');
            if (AppState.locationWatcherId) navigator.geolocation.clearWatch(AppState.locationWatcherId);
            window.location.href = 'login.html'; 
        }
    </script>
</body>
</html>