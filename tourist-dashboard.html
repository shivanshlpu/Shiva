<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Dashboard - SafeTour Connect</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* --- LIGHT/TRUSTWORTHY VIRTUAL ID PALETTE --- */
        :root {
            /* Brand Colors */
            --color-primary: #0072E1;
            --color-accent-happy: #FFC300;
            --color-secondary: #00BCD4; 
            
            /* Backgrounds */
            --primary-bg: #F7F9FF; 
            --secondary-bg: #FFFFFF; 
            
            /* Text & Action */
            --text-color-dark: #333333;
            --text-color-soft: #555555;
            --danger-color: #FF6347;
            --success-color: #28A745; 
            --container-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg), #FFFFFF);
            color: var(--text-color-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
        }
        
        /* --- Navbar --- */
        .navbar {
            width: 100%;
            padding: 1rem 3rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--secondary-bg);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--color-primary);
        }
        .navbar h1 {
            color: var(--color-primary);
            font-weight: 700;
            font-size: 1.6rem;
        }
        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            padding: 0.7rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .logout-btn:hover {
            background-color: #d14931;
            transform: translateY(-2px);
        }

        /* --- Main Content Area --- */
        .card-wrapper {
            background: var(--secondary-bg);
            padding: 3rem;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: var(--container-shadow);
            margin-top: 8rem;
            border: 1px solid #E0E0E0;
        }
        .card-wrapper h2 {
            color: var(--text-color-dark);
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 2rem;
        }
        .no-id-message {
            padding: 2rem 0;
            color: var(--text-color-soft);
        }
        .no-id-message h2 {
            font-size: 1.5rem;
            color: var(--danger-color);
        }

        /* --- VIRTUAL ID CARD STYLES --- */
        .virtual-id-card {
            background: linear-gradient(45deg, var(--color-primary), #0056e6);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: left;
            margin: auto;
            width: 336px;
            height: 192px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
        }
        
        /* Premium Card Styles (Inverted Colors for Download) */
        .virtual-id-card.Gold { background: linear-gradient(45deg, #FFD700, #DAA520); color: #333; }
        .virtual-id-card.Platinum { background: linear-gradient(45deg, #E5E4E2, #C0C0C0); color: #333; }
        .virtual-id-card.Diamond { background: linear-gradient(45deg, #B9F2FF, #40E0D0); color: #333; }
        
        /* Card Header & Content Styles */
        .virtual-id-card h2 { color: white; margin: 0; font-size: 1.2rem; }
        .virtual-id-card.Gold h2, .virtual-id-card.Platinum h2, .virtual-id-card.Diamond h2 { color: var(--text-color-dark); }
        .card-header-style { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
        }
        .card-label-style { background: white; color: var(--text-color-dark); padding: 0.2rem 0.6rem; border-radius: 15px; font-weight: 600; font-size: 0.8rem; }
        .card-content-style { 
            display: flex; 
            align-items: flex-end; 
            justify-content: space-between; 
            flex-grow: 1; 
            padding-top: 5px; 
            width: 100%; 
        }
        
        /* Details and Text */
        .details-style { font-size: 0.8rem; text-align: left; margin-bottom: 0.5rem; }
        .details-style p { margin: 0.1rem 0; display: block; }
        .details-style strong { color: rgba(255, 255, 255, 0.8); }
        .virtual-id-card.Gold .details-style strong, .virtual-id-card.Platinum .details-style strong, .virtual-id-card.Diamond .details-style strong { color: var(--text-color-soft); }

        /* QR Code Container Fix */
        .qr-code-display { 
            padding: 5px; 
            background: white; 
            border-radius: 4px; 
            flex-shrink: 0; 
            height: 80px; 
            width: 80px; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            position: relative;
        }
        .qr-code-display canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: auto !important;
            height: auto !important;
        }
        /* Hide any raw text output from qrcode.js */
        .qr-code-display > div { 
            display: none; 
        } 
        
        /* --- ACTION BUTTONS --- */
        .action-btns-group {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-btn {
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .action-btn#download-btn {
            background-color: var(--color-primary); 
        }
        
        .action-btn#download-btn:hover {
            background-color: #0056e6;
            transform: translateY(-2px);
        }
        
        .action-btn.share {
            background-color: var(--color-secondary);
        }
        
        .action-btn.share:hover {
            background-color: #00a4b8;
            transform: translateY(-2px);
        }

        /* --- Responsiveness --- */
        @media (max-width: 500px) {
            .navbar { padding: 1rem 1.5rem; }
            .navbar h1 { font-size: 1.4rem; }
            .card-wrapper { padding: 1.5rem; margin-top: 6rem; }
        }
    </style>
</head>

<body>
    <header class="navbar">
        <h1><i class="fas fa-id-badge mr-2" style="color: var(--color-accent-happy);"></i> Tourist Dashboard</h1>
        <button class="logout-btn" id="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </button>
    </header>
    
    <div class="card-wrapper" id="card-wrapper">
    </div>
    
    <script>
        const API_BASE_URL = 'http://localhost:3000'; // Server URL

        // --- Fetch User Data from Server ---
        async function fetchTouristDetails(userId) {
            try {
                // Assuming we have an API endpoint to fetch a single user by their MongoDB _id
                const response = await fetch(`${API_BASE_URL}/api/user/${userId}`);
                
                if (!response.ok) {
                    throw new Error("Failed to fetch user data.");
                }
                const data = await response.json();
                return data.user; // Assuming the server returns { user: {...} }

            } catch (error) {
                console.error("Error fetching user details:", error);
                return null;
            }
        }


        // --- Render Logic ---
        async function renderTouristCard(tourist) {
            const cardWrapper = document.getElementById('card-wrapper');
            cardWrapper.innerHTML = ''; // Clear previous content

            if (!tourist || !tourist.virtualID) {
                cardWrapper.innerHTML = `
                    <div class="no-id-message">
                        <h2><i class="fas fa-exclamation-circle" style="color:var(--danger-color);"></i> No Virtual ID Found</h2>
                        <p>Your safety credentials have not been generated yet. Please contact your group admin or guide for assistance.</p>
                        <a href="central-dashboard3.html" class="action-btn" style="background-color: var(--color-primary); margin-top: 1rem;">Go to Live Safety Hub</a>
                    </div>
                `;
                return;
            }
            
            // Render the card if virtualID exists
            const cardHTML = `
                <h2>Your Virtual ID</h2>
                <div class="virtual-id-card ${tourist.virtualID.cardType}" id="display-card">
                    <div class="card-header-style">
                        <h2>Smart Tourist</h2>
                        <span class="card-label-style">${tourist.virtualID.cardType}</span>
                    </div>
                    <div class="card-content-style">
                        <div class="details-style">
                            <p><strong>Name:</strong> <span>${tourist.name || 'N/A'}</span></p>
                            <p><strong>Age:</strong> <span>${tourist.age || 'N/A'}</span></p>
                            <p><strong>Destination:</strong> <span>${tourist.destination || 'N/A'}</span></p>
                            <p><strong>V-ID:</strong> <span>${tourist.virtualID.id || 'N/A'}</span></p>
                        </div>
                        <div class="qr-code-display" id="qr-code-display-container"></div>
                    </div>
                </div>
                <div class="action-btns-group">
                    <button class="action-btn" id="download-btn"><i class="fas fa-download"></i> Download as PNG</button>
                    <button class="action-btn share" id="share-btn"><i class="fas fa-envelope"></i> Share Details</button>
                </div>
            `;
            
            cardWrapper.innerHTML = cardHTML;
            
            // --- QR Code Generation ---
            const qrCodeData = JSON.stringify(tourist.virtualID);
            new QRCode(document.getElementById('qr-code-display-container'), {
                text: qrCodeData,
                width: 70,
                height: 70,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }


        // --- DOM Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
            
            // 1. SECURITY CHECK
            if (!loggedInUser || !loggedInUser._id) {
                 window.location.href = 'login.html';
                 return;
            }
            
            // 2. FETCH LATEST USER DATA
            // NOTE: We assume the user's MongoDB _id is stored in localStorage.loggedInUser._id
            const freshTouristData = await fetchTouristDetails(loggedInUser._id);

            // 3. RENDER CARD
            await renderTouristCard(freshTouristData);

            // 4. ATTACH DYNAMIC LISTENERS (Only after the card is rendered)
            if (freshTouristData && freshTouristData.virtualID) {
                const tourist = freshTouristData; // Alias for clarity

                document.getElementById('download-btn').addEventListener('click', () => {
                    const card = document.getElementById('display-card');
                    html2canvas(card, { scale: 2 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `VirtualID_${tourist.name.replace(/\s/g, '')}.png`;
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    });
                });
                
                document.getElementById('share-btn').addEventListener('click', () => {
                    const subject = encodeURIComponent("Your Smart Tourist Virtual ID");
                    const body = encodeURIComponent(
                        `Hello ${tourist.name},\n\n` +
                        `Your virtual ID is ready for your trip to ${tourist.destination}. Your ID confirms your safety plan.\n\n` +
                        `* Name: ${tourist.name}\n` +
                        `* Card Type: ${tourist.virtualID.cardType}\n\n` +
                        `Safe Travels,\nSafeTour Connect`
                    );
                    window.location.href = `mailto:?subject=${subject}&body=${body}`;
                });
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            window.location.href = 'login.html';
        });
    </script>
</body>
</html>